<!DOCTYPE html>
<!--
  Datei: nova_chatbot_commented.html
  Beschreibung:
    Dies ist die Frontendâ€‘Datei (HTML/CSS/JS) fÃ¼r den Chatbot "Nova",
    der Nutzern bei Fragen rund um BoseÂ­Produkte hilft. Die Datei enthÃ¤lt
    ausschlieÃŸlich PrÃ¤sentationsâ€‘ und Clientâ€‘Logik. Alle Aufrufe an den
    Server (Flask Backâ€‘End) erfolgen via Fetchâ€‘API.
-->
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nova - Chatbot fÃ¼r Bose-Produkte</title>
  <!--
    Verweis auf die zentrale Stylesheetâ€‘Datei. 
  -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <!--
    Hauptelement (Flexâ€‘Layout)
    EnthÃ¤lt die seitliche Navigationsleiste (sidebar) sowie den eigentlichen
    Chatbereich (chat-container).
  -->
  <div class="container">
    <!--
      =============== Sidebar ===============
      Beinhaltet Logo, Eâ€‘Mailâ€‘Eingabefeld, Liste vorhandener Chatâ€‘Sessions
      sowie Buttons fÃ¼r neue Session / Beenden.
    -->
    <div class="sidebar">
      <!-- Avatar/Logo fÃ¼r Nova -->
      <img src="{{ url_for('static', filename='Nova.png') }}" alt="Nova" class="nova-image">

      <!--
        Eâ€‘Mailâ€‘Eingabe: Speichert (optionale) Nutzeradresse, damit der Server
        eindeutige Sessions pro Kunde anlegen kann.
      -->
      <div class="email-container">
        <label for="email-input">Gib deine E-Mail ein:</label>
        <input type="email" id="email-input" placeholder="name@example.com">
        <button id="save-email">Speichern</button>
      </div>

      <!-- Liste bereits bestehender Chat-Sessions fÃ¼r eingeloggte Nutzer -->
      <div id="chat-session-list">
        <h3>Vorherige Chats</h3>
        <ul id="session-list"></ul>
      </div>

      <!-- Anzeige der momentan aktiven Chat-ID -->
      <div id="chat-id-container">
        <span id="current-chat-id"></span>
      </div>

      <!--
        Untere Buttonâ€‘Leiste in der Sidebar: Infoâ€‘Toggle, neue Session, Ende.
      -->
      <div class="bottom-bar">
        <button class="about-toggle" id="about-toggle">?</button>
        <div class="buttons-group">
          <button id="new-session">Neue Session</button>
          <button class="end-chat-button" id="end-chat">Beenden</button>
        </div>
      </div>
    </div> <!-- /sidebar -->

    <!--
      =============== Chat-Bereich ===============
      Zeigt Verlauf sowie Eingabefeld (Form) fÃ¼r neue Nachrichten.
    -->
    <div class="chat-container">
      <!-- Container fÃ¼r Chatnachrichten -->
      <div id="chatbox"><!-- Nachrichten werden dynamisch per JS eingefÃ¼gt --></div>

      <!-- Formular fÃ¼r Nutzereingaben -->
      <form id="chat-form">
        <input type="text" id="user-input" placeholder="Stelle Nova eine Frage..." autocomplete="off">
        <button type="submit">Senden</button>
      </form>
    </div> <!-- /chat-container -->
  </div> <!-- /container -->

  <!--
    =============== Aboutâ€‘Sidebar ===============
    Klappt beim Klick auf das Fragezeichen auf. Liefert ErlÃ¤uterungen zu
    Funktionen fÃ¼r anonyme Nutzer vs. Bestandskunden.
  -->
  <div class="about-sidebar" id="about-sidebar">
    <h2>About Nova</h2>
    <p>
      Nova ist dein virtueller Assistent fÃ¼r Bose-Produkte. Sie hilft dir bei Fragen, 
      Problemen und Anleitungen rund um deine GerÃ¤te.
    </p>
    
    <!-- Abschnitt: anonyme Nutzung -->
    <h3>Anonyme Nutzung</h3>
    <p>Wenn du dich nicht anmeldest, kannst du:</p>
    <ul>
      <li>Allgemeine Fragen zu Bose-Produkten stellen</li>
      <li>Kurze Anleitungen abrufen (z.B. Verbindung herstellen)</li>
    </ul>
    <p>Beispielfragen:</p>
    <ul>
      <li>Wie schlieÃŸe ich meine Lautsprecher an?</li>
      <li>Was mache ich, wenn mein GerÃ¤t nicht funktioniert?</li>
      <li>Welche Produkte passen zu meinem Setup?</li>
    </ul>
    
    <!-- Abschnitt: Vorteile fÃ¼r Bestandskunden -->
    <h3>Vorteile als Bestandskunde</h3>
    <p>Wenn du dich anmeldest, kannst du zusÃ¤tzlich:</p>
    <ul>
      <li>Auf deine gespeicherten Chat-VerlÃ¤ufe zugreifen und diese fortfÃ¼hren</li>
      <li>PersÃ¶nliche Daten abrufen (z.B. gekaufte Produkte, Bestellhistorie)</li>
      <li>Gezieltere Produktempfehlungen erhalten</li>
    </ul>
    <p>Beispielfragen:</p>
    <ul>
      <li>Welche Produkte habe ich zuletzt gekauft?</li>
      <li>Wie kann ich meine bisherigen Bestellungen einsehen?</li>
      <li>Welche Garantie habe ich auf meine GerÃ¤te?</li>
    </ul>
  </div> <!-- /about-sidebar -->
  
  <!--
    =======================================================
    JavaScript: Clientâ€‘seitige Logik
    =======================================================
    EnthÃ¤lt:
      * DOMâ€‘Hooks & Eventlistener
      * Fetchâ€‘Aufrufe zu Flaskâ€‘Routen (/start-session, /chat, ...)
      * Dynamische Darstellung eingehender/ausgehender Nachrichten
  -->
  <script>
    // === Elementâ€‘Referenzen ===
    const form            = document.getElementById('chat-form');
    const chatbox         = document.getElementById('chatbox');
    const aboutSidebar    = document.getElementById('about-sidebar');
    const aboutToggle     = document.getElementById('about-toggle');
    const sessionListElem = document.getElementById('session-list');

    /* ----------------------------------------------------
       BegrÃ¼ÃŸungsnachricht beim ersten Laden
       ---------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Anonyme Session beim Erstbesuch anlegen
      const resp = await fetch('/start-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'email=' // Leerer Wert => "anonymous" auf Server
      });
      const data = await resp.json();

      if (data.chat_id) {
        window.chatId = data.chat_id; // globale Chatâ€‘ID merken
        // Chat-ID im UI anzeigen
        document.getElementById('current-chat-id').textContent = `Chat-ID: ${data.chat_id}`;
      }

      // BegrÃ¼ÃŸungs-Bubble einfÃ¼gen
      chatbox.innerHTML += `
        <div class="bot-message">
          <div class="message-sender">Nova</div>
          <div class="message-content">
            <p>ğŸ‘‹ <strong>Hallo und herzlich willkommen!</strong><br>
            Ich bin <strong>Nova</strong>, deine virtuelle Assistentin. Es freut mich, dass du hier bist! ğŸ˜Š</p>
            <p>ğŸ“Œ <strong>Wie kann ich dir heute helfen?</strong><br>
            Hast du Fragen zu <strong>Bose-Produkten</strong> oder benÃ¶tigst du UnterstÃ¼tzung? Ich bin hier, um dich Schritt fÃ¼r Schritt zu begleiten und dir zu helfen. ğŸ’¡</p>
          </div>
        </div>`;
      chatbox.scrollTop = chatbox.scrollHeight;

      // Vorhandene Sessions laden (falls eingeloggt)
      loadSessions();
    });

    /**
     * Setzt erneut die initiale BegrÃ¼ÃŸung (z.B. nach Sessionâ€‘Wechsel).
     */
    function setNovaGreeting() {
      chatbox.innerHTML = `
        <div class="bot-message">
          <div class="message-sender">Nova</div>
          <div class="message-content">
            <p>ğŸ‘‹ <strong>Hallo und herzlich willkommen!</strong><br>
            Ich bin <strong>Nova</strong>, deine virtuelle Assistentin. Es freut mich, dass du hier bist! ğŸ˜Š</p>
            <p>ğŸ“Œ <strong>Wie kann ich dir heute helfen?</strong><br>
            Hast du Fragen zu <strong>Bose-Produkten</strong> oder benÃ¶tigst du UnterstÃ¼tzung?
            Ich bin hier, um dich Schritt fÃ¼r Schritt zu begleiten und dir zu helfen. ğŸ’¡</p>
          </div>
        </div>`;
    }

    /**
     * Helfer zum HinzufÃ¼gen einer Botâ€‘Nachricht (ohne erneutes Scrollen).
     */
    function addBotMessage(message) {
      chatbox.innerHTML += `
        <div class="bot-message">
          <div class="message-sender">Nova</div>
          <div class="message-content">${message}</div>
        </div>`;
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // === Aboutâ€‘Sidebar ein/ausklappen ===
    aboutToggle.addEventListener('click', () => {
      aboutSidebar.classList.toggle('open');
      document.querySelector('.container').classList.toggle('shifted');
    });

    // ----------------------------------------
    //  Eâ€‘Mail speichern und (neu) einloggen  
    // ----------------------------------------
    let currentEmail = "anonymous"; // Default

    document.getElementById('save-email').addEventListener('click', async () => {
      const newEmail = document.getElementById('email-input').value.trim() || "anonymous";
  
      // Falldifferenzierung: Nutzer wechselt von E-Mail A zu B (nicht "anonymous")
      if (currentEmail !== "anonymous" && currentEmail !== newEmail) {
        // 1) Alte Session beenden
        await fetch('/end-session', { method: 'POST' });
  
        // 2) Chatfenster leeren & BegrÃ¼ÃŸung setzen
        document.getElementById('chatbox').innerHTML = '';
        setNovaGreeting();
      }
  
      // 3) Neue Session starten (email an Server senden)
      const resp = await fetch('/start-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `email=${encodeURIComponent(newEmail)}`
      });
      const data = await resp.json();
      
      if (data.error) {
        alert(data.error);
      } else {
        // 4) Session-ID Ã¼bernehmen
        window.chatId = data.chat_id;
        document.getElementById('current-chat-id').textContent = `Chat-ID: ${data.chat_id}`;
        alert(`Neue Session gestartet unter E-Mail: ${newEmail}`);
      }
  
      // 5) Globale Mail-Adresse aktualisieren
      currentEmail = newEmail;
  
      // 6) Sessions neu laden
      loadSessions();
    });

    // ----------------------------------------
    //  Formular: Nachricht absenden           
    // ----------------------------------------
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // Seite nicht neuladen

      const userInput  = document.getElementById('user-input').value;
      const emailInput = document.getElementById('email-input').value; // evtl. spÃ¤ter genutzt
      
      // Nutzereingabe anzeigen
      chatbox.innerHTML += `
        <div class="user-message">
          <div class="message-sender">Du</div>
          <div class="message-content">${userInput}</div>
        </div>`;
      document.getElementById('user-input').value = '';
    
      // Ladeanimation einsetzen
      let loadingBox = document.createElement('div');
      loadingBox.className = 'loading-box';
      loadingBox.innerHTML = `
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>`;
      chatbox.appendChild(loadingBox);
      loadingBox.style.display = 'flex';
      chatbox.scrollTop = chatbox.scrollHeight;
    
      try {
        // POST an /chat senden (JSON)
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: userInput,
            chat_id: window.chatId
          })
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || `HTTP-Error: ${response.status}`);
        }
    
        const data = await response.json();
        loadingBox.remove();
    
        if (data.error) {
          // Fehlermeldung des Bots anzeigen
          chatbox.innerHTML += `
            <div class="bot-message error">
              <div class="message-sender">Nova (Fehler)</div>
              <div class="message-content">
                <p>${data.error}</p>
              </div>
            </div>`;
        } else {
          // Normale Botâ€‘Antwort anzeigen
          chatbox.innerHTML += `
            <div class="bot-message">
              <div class="message-sender">Nova</div>
              <div class="message-content">${data.response}</div>
            </div>`;
        }
      } catch (err) {
        loadingBox.remove();
        chatbox.innerHTML += `
          <div class="bot-message error">
            <div class="message-sender">Nova (Fehler)</div>
            <div class="message-content">
              <p><strong>Fehler beim Senden der Anfrage:</strong></p>
              <p>${err.message}</p>
            </div>
          </div>`;
      }
    
      chatbox.scrollTop = chatbox.scrollHeight;
      loadSessions(); // Liste ggf. updaten (z.B. wenn neue Session erzeugt wurde)
    });

    // ----------------------------------------
    //  Neue Session (Button in Sidebar)       
    // ----------------------------------------
    document.getElementById('new-session').addEventListener('click', async () => {
      // Aktuelle (oder leere => anonymous) Mailadresse holen
      const currentEmail = document.getElementById('email-input').value.trim() || "anonymous";
      
      // Neue Session anfordern
      const resp = await fetch('/start-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `email=${encodeURIComponent(currentEmail)}`
      });
      const data = await resp.json();

      if (data.error) {
        alert(data.error);
      } else if (data.chat_id) {
        window.chatId = data.chat_id; // neue Chatâ€‘ID
        document.getElementById('current-chat-id').textContent = `Chat-ID: ${data.chat_id}`;

        // Chatbox leeren und BegrÃ¼ÃŸung neu anzeigen
        document.getElementById('chatbox').innerHTML = '';
        setNovaGreeting();

        alert(`Neue Session gestartet fÃ¼r ${currentEmail}`);

        loadSessions();
      }
    });
    
    // ----------------------------------------
    //  Session beenden (Button "Beenden")     
    // ----------------------------------------
    document.getElementById('end-chat').addEventListener('click', async () => {
      // 1) Aktive Session beenden
      const endResp = await fetch('/end-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const endData = await endResp.json();
      if (endData.message) {
        alert(endData.message);
      }
    
      // 2) Eâ€‘Mail Feld zurÃ¼cksetzen
      document.getElementById('email-input').value = '';
    
      // 3) Neue anonyme Session starten
      const newSessionResp = await fetch('/start-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'email=' // leeres Feld => anonymous
      });
      const newSessionData = await newSessionResp.json();
      window.chatId = newSessionData.chat_id;
      document.getElementById('current-chat-id').textContent = `Chat-ID: ${newSessionData.chat_id}`;
    
      // 4) BegrÃ¼ÃŸung anzeigen + Liste updaten
      setNovaGreeting();
      loadSessions();
    });

    // ----------------------------------------
    //  Bisherige Sessions abrufen (Sidebar)   
    // ----------------------------------------
    async function loadSessions() {
      let emailInputValue = document.getElementById('email-input').value.trim();
      if (emailInputValue.toLowerCase() === "anonymous") {
        emailInputValue = ""; // Server erwartet leeren String fÃ¼r anonymous
      }
    
      // Wenn keine Mail hinterlegt -> Hinweis anzeigen & abbrechen
      if (!emailInputValue) {
        sessionListElem.innerHTML = `
          <li style="list-style:none; font-style: italic; color: #666;">
              Du bist aktuell nicht angemeldet.<br>
              Bitte gib deine E-Mail ein, um auf vorherige Chats zugreifen zu kÃ¶nnen.
          </li>
        `;
        return;
      }
      
      const response = await fetch('/get-sessions');
      const sessions  = await response.json();
      sessionListElem.innerHTML = '';
      
      // Jede Session als Listenelement rendern
      sessions.forEach(sessionItem => {
        const li = document.createElement('li');
        const date = new Date(sessionItem.created_at).toLocaleString();
        li.textContent = `Chat vom ${date}`;
        li.dataset.chatId = sessionItem.id;
    
        // Klick auf eine Session: umschalten
        li.addEventListener('click', async () => {
          const selectResp = await fetch(`/select-session/${sessionItem.id}`, { method: 'POST' });
          if (!selectResp.ok) {
            alert("Fehler beim Umschalten auf diesen Chat");
            return;
          }

          window.chatId = sessionItem.id;
          document.getElementById('current-chat-id').textContent = `Chat-ID: ${sessionItem.id}`;
          await loadSessionConversation(sessionItem.id);
        });

        sessionListElem.appendChild(li);
      });
    }
    
    // ----------------------------------------
    //  Einzelnen Chatverlauf nachladen         
    // ----------------------------------------
    async function loadSessionConversation(chatId) {
      const response   = await fetch(`/get-session/${chatId}`);
      const sessionData = await response.json();

      if(sessionData.error) {
        alert(sessionData.error);
        return;
      }

      window.chatId = sessionData.id;
      chatbox.innerHTML = '';

      // BegrÃ¼ÃŸung erneut setzen
      chatbox.innerHTML += `
      <div class="bot-message">
        <div class="message-sender">Nova</div>
        <div class="message-content">
          <p>ğŸ‘‹ <strong>Hallo und herzlich willkommen!</strong><br>
          Ich bin <strong>Nova</strong>, deine virtuelle Assistentin. Es freut mich, dass du hier bist! ğŸ˜Š</p>
          <p>ğŸ“Œ <strong>Wie kann ich dir heute helfen?</strong><br>
          Hast du Fragen zu <strong>Bose-Produkten</strong> oder benÃ¶tigst du UnterstÃ¼tzung? 
          Ich bin hier, um dich Schritt fÃ¼r Schritt zu begleiten und dir zu helfen. ğŸ’¡</p>
        </div>
      </div>
      `;

      // Vorherige Nachrichten rendern
      sessionData.messages.forEach(msg => {
        if(msg.sender === 'user') {
          chatbox.innerHTML += `
            <div class="user-message">
              <div class="message-sender">Du</div>
              <div class="message-content">${msg.content}</div>
            </div>`;
        } else {
          chatbox.innerHTML += `
            <div class="bot-message">
              <div class="message-sender">Nova</div>
              <div class="message-content">${msg.content}</div>
            </div>`;
        }
      });
      chatbox.scrollTop = chatbox.scrollHeight;
    }
  </script>
</body>
</html>